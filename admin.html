<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Admin Pr√©pa+</title>
  
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  
  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background: #f4f4f4;
      padding: 20px;
      color: #2c3e50;
      max-width: 600px;
      margin: 0 auto;
    }
    h2 {
      text-align: center;
      margin-bottom: 20px;
      color: #2c3e50;
    }
    label {
      display: block;
      margin-top: 15px;
      font-weight: bold;
      font-size: 0.9em;
    }
    input, textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border-radius: 6px;
      border: 1px solid #ccc;
      box-sizing: border-box;
    }
    button {
      margin-top: 20px;
      padding: 12px;
      width: 100%;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 1em;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }
    button:hover {
      background-color: #1a252f;
    }
    .success, .error {
      margin-top: 15px;
      padding: 10px;
      border-radius: 6px;
      text-align: center;
      font-weight: bold;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    #authSection, #formulaire, #listeQuizzes {
      background: white;
      padding: 20px;
      border-radius: 10px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05);
      margin-bottom: 30px;
    }

    /* Styles pour la liste des questions */
    .quiz-item {
        border: 1px solid #eee;
        padding: 10px;
        margin-bottom: 10px;
        border-radius: 6px;
        background-color: #f9f9f9;
        text-align: left;
    }
    .quiz-item strong {
        display: block;
        color: #007bff;
        margin-bottom: 5px;
    }
    .quiz-item button {
        width: auto;
        padding: 5px 10px;
        margin-top: 5px;
        margin-right: 5px;
        font-size: 0.8em;
    }
  </style>
</head>
<body>

  <h2>üîê Panneau d'Administration Pr√©pa+</h2>
  
  <div id="authSection">
    <h3>Connexion Admin</h3>
    <label for="adminEmail">Email</label>
    <input type="email" id="adminEmail" value="gabbyumba344@gmail.com" placeholder="admin@votreapp.com" />
    
    <label for="adminPassword">Mot de passe</label>
    <input type="password" id="adminPassword" placeholder="Mot de passe" />
    
    <button onclick="seConnecter()">Se connecter</button>
    <div id="authMessage" class="error" style="display: none;"></div>
  </div>

  <div id="formulaire" style="display: none;">
    <h2 id="formTitle">‚ûï Ajouter un Quiz</h2>

    <label for="matiere">Mati√®re</label>
    <input type="text" id="matiere" placeholder="Ex: Histoire" />

    <label for="niveau">Niveau</label>
    <input type="text" id="niveau" placeholder="Ex: Interm√©diaire" />

    <label for="question">Question</label>
    <textarea id="question" rows="2" placeholder="Ex: Quand a eu lieu la R√©volution fran√ßaise ?"></textarea>

    <label for="options">Options (s√©par√©es par des virgules)</label>
    <input type="text" id="options" placeholder="Ex: 1789, 1800, 1914" />

    <label for="bonneReponse">Bonne r√©ponse</label>
    <input type="text" id="bonneReponse" placeholder="Ex: 1789" />

    <label for="explication">Explication</label>
    <textarea id="explication" rows="3" placeholder="Ex: Elle a commenc√© en 1789 avec la prise de la Bastille."></textarea>

    <button id="mainFormButton" onclick="gererSoumissionQuiz()">Ajouter le quiz</button>
    
    <div id="feedbackMessage" style="display: none;"></div>
    
    <button onclick="deconnexion()" style="background-color: #888; margin-top: 10px;">Se d√©connecter</button>
  </div>
  
  <div id="listeQuizzes" style="display: none;">
      <h2>üìã Quizzes Existants</h2>
      <div id="quizzesContainer">Chargement...</div>
  </div>


  <script>
    // --- IDENTIFIANTS COD√âS EN DUR (ATTENTION : S√âCURIT√â FAIBLE !) ---
    const ADMIN_EMAIL = "gabbyumba344@gmail.com";
    const ADMIN_PASSWORD = "prepa2025";
    let estConnecte = false;
    // -----------------------------------------------------------------

    const firebaseConfig = {
      apiKey: "AIzaSyAuHPWVOkd96xPqKQ_K1cC4n4ihuPfuNFQ",
      authDomain: "abiga-1718.firebaseapp.com",
      projectId: "abiga-1718",
      storageBucket: "abiga-1718.appspot.com",
      messagingSenderId: "103455679291",
      appId: "1:103455679291:web:eda13441fedfce226d4d1e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    let quizEnEditionId = null;

    // --- LOGIQUE D'AUTHENTIFICATION LOCALE ---
    
    // Fonction qui met √† jour l'interface en fonction de l'√©tat de connexion
    function mettreAJourUI() {
        if (estConnecte) {
            document.getElementById("authSection").style.display = "none";
            document.getElementById("formulaire").style.display = "block";
            document.getElementById("listeQuizzes").style.display = "block";
            chargerListeQuizzes();
        } else {
            document.getElementById("authSection").style.display = "block";
            document.getElementById("formulaire").style.display = "none";
            document.getElementById("listeQuizzes").style.display = "none";
            quizEnEditionId = null;
        }
    }

    // Fonction de connexion : v√©rification des cha√Ænes de caract√®res
    function seConnecter() {
        const email = document.getElementById("adminEmail").value;
        const password = document.getElementById("adminPassword").value;
        const authMsg = document.getElementById("authMessage");
        authMsg.style.display = "none";

        if (email === ADMIN_EMAIL && password === ADMIN_PASSWORD) {
            estConnecte = true;
            // Stocke l'√©tat de connexion dans la session (pour ne pas perdre la connexion au rechargement)
            sessionStorage.setItem('admin_logged_in', 'true'); 
            mettreAJourUI();
        } else {
            authMsg.className = "error";
            authMsg.innerText = "Erreur de connexion : V√©rifiez l'email/mot de passe.";
            authMsg.style.display = "block";
        }
    }
    
    // Initialisation au chargement de la page
    window.onload = function() {
        if (sessionStorage.getItem('admin_logged_in') === 'true') {
            estConnecte = true;
        }
        mettreAJourUI();
    };

    function deconnexion() {
        estConnecte = false;
        sessionStorage.removeItem('admin_logged_in');
        mettreAJourUI();
        document.getElementById("authMessage").style.display = "none";
        document.getElementById("feedbackMessage").style.display = "none";
    }

    // --- FONCTIONS CRUD (FORMULAIRE) ---
    
    async function gererSoumissionQuiz() {
        if (!estConnecte) return; // S√©curit√© de base
        if (quizEnEditionId) {
            await modifierQuiz(quizEnEditionId);
        } else {
            await ajouterQuiz();
        }
    }

    async function ajouterQuiz() {
      const matiere = document.getElementById("matiere").value.trim();
      const niveau = document.getElementById("niveau").value.trim();
      const question = document.getElementById("question").value.trim();
      const optionsRaw = document.getElementById("options").value.trim();
      const bonneReponse = document.getElementById("bonneReponse").value.trim();
      const explication = document.getElementById("explication").value.trim();
      const feedback = document.getElementById("feedbackMessage");
      
      feedback.style.display = "none";
      const options = optionsRaw.split(',').map(opt => opt.trim()).filter(opt => opt);

      if (!matiere || !niveau || !question || options.length < 2 || !bonneReponse || !explication) {
        feedback.className = "error";
        feedback.innerText = "üõë Remplis tous les champs correctement.";
        feedback.style.display = "block";
        return;
      }

      try {
        await db.collection("quizzes").add({
          mati√®re: matiere,
          niveau: niveau,
          question: question,
          options: options,
          bonneReponse: bonneReponse,
          explication: explication,
          dateAjout: firebase.firestore.FieldValue.serverTimestamp()
        });

        feedback.className = "success";
        feedback.innerText = "‚úÖ Quiz ajout√© avec succ√®s !";
        feedback.style.display = "block";
        
        reinitialiserFormulaire();
        
      } catch (error) {
        feedback.className = "error";
        feedback.innerText = "‚ùå Erreur lors de l'ajout : " + error.message;
        feedback.style.display = "block";
      }
    }

    async function modifierQuiz(id) {
        const matiere = document.getElementById("matiere").value.trim();
        const niveau = document.getElementById("niveau").value.trim();
        const question = document.getElementById("question").value.trim();
        const optionsRaw = document.getElementById("options").value.trim();
        const bonneReponse = document.getElementById("bonneReponse").value.trim();
        const explication = document.getElementById("explication").value.trim();
        const feedback = document.getElementById("feedbackMessage");
        
        feedback.style.display = "none";
        const options = optionsRaw.split(',').map(opt => opt.trim()).filter(opt => opt);

        if (!matiere || !niveau || !question || options.length < 2 || !bonneReponse || !explication) {
            feedback.className = "error";
            feedback.innerText = "üõë Remplis tous les champs correctement.";
            feedback.style.display = "block";
            return;
        }

        try {
            await db.collection("quizzes").doc(id).update({
              mati√®re: matiere,
              niveau: niveau,
              question: question,
              options: options,
              bonneReponse: bonneReponse,
              explication: explication
            });

            feedback.className = "success";
            feedback.innerText = "‚úÖ Quiz modifi√© avec succ√®s !";
            feedback.style.display = "block";

            reinitialiserFormulaire();
            
        } catch (error) {
            feedback.className = "error";
            feedback.innerText = "‚ùå Erreur lors de la modification : " + error.message;
            feedback.style.display = "block";
        }
    }

    function reinitialiserFormulaire() {
        // Vider les champs
        document.getElementById("matiere").value = "";
        document.getElementById("niveau").value = "";
        document.getElementById("question").value = "";
        document.getElementById("options").value = "";
        document.getElementById("bonneReponse").value = "";
        document.getElementById("explication").value = "";

        // Revenir au mode 'Ajouter'
        quizEnEditionId = null;
        document.getElementById("formTitle").textContent = "‚ûï Ajouter un Quiz";
        document.getElementById("mainFormButton").textContent = "Ajouter le quiz";

        // Supprimer le bouton 'Annuler' si pr√©sent
        const cancelButton = document.getElementById('cancelEditBtn');
        if (cancelButton) {
            cancelButton.remove();
        }
        
        document.getElementById("feedbackMessage").style.display = "none";
        chargerListeQuizzes(); // Rafra√Æchir la liste
    }


    // --- FONCTIONS DE GESTION DE LA LISTE ---

    async function chargerListeQuizzes() {
        const container = document.getElementById("quizzesContainer");
        container.innerHTML = "Chargement des questions...";

        try {
            const snapshot = await db.collection("quizzes").orderBy("dateAjout", "desc").get();
            container.innerHTML = "";
            
            if (snapshot.empty) {
                container.innerHTML = "Aucune question trouv√©e.";
                return;
            }

            snapshot.forEach(doc => {
                const data = doc.data();
                const id = doc.id;
                
                const item = document.createElement('div');
                item.className = 'quiz-item';
                item.innerHTML = `
                    <strong>[${data.mati√®re} - ${data.niveau}] Question :</strong> ${data.question}<br>
                    R√©ponse : ${data.bonneReponse}<br>
                    Options : ${data.options.join(', ')}
                    <button onclick="chargerPourModification('${id}')" style="background-color: #3498db;">Modifier</button>
                    <button onclick="supprimerQuiz('${id}')" style="background-color: #e74c3c;">Supprimer</button>
                `;
                container.appendChild(item);
            });
            
        } catch (error) {
            container.innerHTML = "Erreur lors du chargement de la liste.";
        }
    }

    async function chargerPourModification(id) {
        const doc = await db.collection("quizzes").doc(id).get();
        if (!doc.exists) {
            alert("Ce quiz n'existe plus !");
            return;
        }
        
        const data = doc.data();
        
        // Remplir le formulaire avec les donn√©es
        document.getElementById("matiere").value = data.mati√®re;
        document.getElementById("niveau").value = data.niveau;
        document.getElementById("question").value = data.question;
        document.getElementById("options").value = data.options.join(', ');
        document.getElementById("bonneReponse").value = data.bonneReponse;
        document.getElementById("explication").value = data.explication;

        // Passer en mode 'Modification'
        quizEnEditionId = id;
        document.getElementById("formTitle").textContent = "‚úèÔ∏è Modifier un Quiz";
        document.getElementById("mainFormButton").textContent = "Enregistrer les modifications";
        
        // Ajouter un bouton 'Annuler' si non pr√©sent
        if (!document.getElementById('cancelEditBtn')) {
            const cancelButton = document.createElement('button');
            cancelButton.id = 'cancelEditBtn';
            cancelButton.textContent = 'Annuler la modification';
            cancelButton.style.backgroundColor = '#888';
            cancelButton.onclick = reinitialiserFormulaire;
            // Ins√©rer juste avant le bouton de d√©connexion
            const disconnectBtn = document.querySelector('#formulaire button[onclick="deconnexion()"]');
            document.getElementById('formulaire').insertBefore(cancelButton, disconnectBtn);
        }

        window.scrollTo(0, 0); 
        document.getElementById("feedbackMessage").style.display = "none";
    }
    
    async function supprimerQuiz(id) {
        if (!confirm("√ätes-vous s√ªr de vouloir supprimer d√©finitivement ce quiz ?")) {
            return;
        }
        
        try {
            await db.collection("quizzes").doc(id).delete();
            alert("Quiz supprim√© avec succ√®s !");
            chargerListeQuizzes();
        } catch (error) {
            alert("Erreur lors de la suppression : " + error.message);
        }
    }
  </script>
</body>
</html>
