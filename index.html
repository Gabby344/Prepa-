<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Pr√©pa+ ‚Äî R√©vise avec clart√©</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@600&family=Open+Sans&display=swap" rel="stylesheet" />

  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>

  <style>
    body {
      font-family: 'Open Sans', sans-serif;
      background: linear-gradient(to right, #eef2f3, #dbe4ea);
      color: #2c3e50;
      margin: 0;
      padding: 20px;
      text-align: center;
      animation: fadeIn 1.5s ease forwards;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(20px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 2.8em;
      margin-top: 20px;
      color: #2c3e50;
      letter-spacing: 1px;
    }

    .slogan {
      font-style: italic;
      font-size: 1.1em;
      margin-bottom: 30px;
      color: #555;
    }

    .grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 30px;
    }

    .grid button {
      padding: 15px;
      font-size: 1em;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 10px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 6px rgba(0,0,0,0.1);
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .grid button:hover {
      background-color: #1a252f;
      transform: scale(1.05);
    }

    .progress {
      margin: 20px auto;
      width: 80%;
      background-color: #ccc;
      border-radius: 20px;
      overflow: hidden;
    }

    .progress-bar {
      height: 20px;
      width: 0%; 
      background-color: #25D366;
      transition: width 1s ease;
    }

    .quote {
      margin-top: 30px;
      font-style: italic;
      color: #666;
      font-size: 1em;
    }

    .page {
      background: #fff;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin: 10px auto;
      width: 90%;
      text-align: left;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      animation: fadeIn 0.8s ease;
    }

    .page h3 {
      margin-bottom: 10px;
      font-size: 1.1em;
    }

    .page button {
      display: block;
      margin: 5px 0;
      padding: 10px;
      width: 100%;
      background-color: #2c3e50;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
    }

    .page button:hover {
      background-color: #1a252f;
    }

    /* Styles pour le feedback visuel du Quiz */
    .page button:disabled {
        opacity: 0.6;
        cursor: default;
        transition: none;
    }
    
    .explication {
      margin-top: 15px;
      padding: 10px;
      border-radius: 5px;
      line-height: 1.4;
      font-size: 0.95em;
      background-color: #f4f6f8;
      color: #2c3e50;
      text-align: left;
      border-left: 5px solid #2c3e50; 
    }
    
    .explication strong {
        font-weight: bold;
        color: #1a252f;
    }

    /* Style pour les pages de contenu (Fiches, D√©fis, Coaching) */
    .content-page {
        background: #fff;
        border-radius: 10px;
        padding: 30px;
        margin: 20px auto;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        text-align: left;
    }
    .content-page h2 {
        text-align: center;
        color: #2c3e50;
        margin-bottom: 20px;
    }
    .content-page p {
        text-align: center;
        margin-bottom: 30px;
        color: #555;
    }
    .content-page button {
        width: 50%;
        margin: 0 auto;
        display: block;
        background-color: #3498db;
    }
    .content-page button:hover {
        background-color: #2980b9;
    }
    
    /* Style pour le menu de filtre */
    .quiz-filter {
        text-align: center;
        margin-bottom: 20px;
        padding: 10px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 4px rgba(0,0,0,0.05);
    }

    .quiz-filter label, .quiz-filter select {
        font-size: 1em;
        font-weight: bold;
        color: #2c3e50;
    }

    .quiz-filter select {
        padding: 8px 10px;
        border-radius: 5px;
        border: 1px solid #ccc;
        margin-left: 10px;
        cursor: pointer;
        width: 150px;
    }


    .admin-link {
      margin-top: 30px;
    }

    .admin-link a {
      text-decoration: none;
    }

    .admin-link button {
      padding: 10px 20px;
      background-color: #888;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 0.9em;
      cursor: pointer;
      transition: background-color 0.2s ease;
    }

    .admin-link button:hover {
      background-color: #555;
    }

    footer {
      margin-top: 40px;
      font-size: 0.9em;
      color: #777;
    }
  </style>
</head>
<body>

  <div id="dashboardPage"> 

    <div class="logo">üìò Pr√©pa+</div>
    <div class="slogan">R√©vise avec clart√©. Progresse avec fiert√©.</div>

    <div class="grid">
      <button onclick="changerPage('quiz')">üìö Quiz</button> 
      <button onclick="changerPage('fiches')">üìÑ Fiches</button>
      <button onclick="changerPage('defis')">üèÜ D√©fis</button>
      <button onclick="changerPage('coaching')">üß† Coaching IA</button>
    </div>

    <div class="progress">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    <p>Tu as r√©vis√© <strong id="progressText">0%</strong> cette semaine</p>

    <div class="quote">‚ÄúTon avenir m√©rite ton attention aujourd‚Äôhui.‚Äù</div>
    
    <div class="quiz-filter">
        <label for="matiereSelect">Mati√®re :</label>
        <select id="matiereSelect" onchange="changerMatiere()">
            <option value="tout">Toutes les Mati√®res</option>
            </select>
        <button onclick="chargerQuiz()" style="width: auto; margin-top: 10px; padding: 8px 15px; background-color: #3498db; margin-left: 10px;">Recharger le Quiz</button>
    </div>

    <div id="quizContainer">
        <div class="page" style="text-align: center; padding: 30px;">
            S√©lectionne une mati√®re ou clique sur "Recharger le Quiz" pour commencer !
        </div>
    </div>

    <div class="admin-link">
      <a href="admin.html"><button>üîê Acc√®s Admin</button></a>
    </div>

  </div> 
  <div id="fichesPage" class="content-page" style="display: none;">
      <h2>üìÑ Mes Fiches de R√©vision</h2>
      <p>Bienvenue dans l'espace Fiches. Cet endroit est d√©di√© √† la consolidation de tes connaissances par la lecture.</p>
      
      <h3>Th√®mes Disponibles :</h3>
      <ul>
        <li>G√©ographie : Les grands fleuves africains</li>
        <li>Histoire : L'ind√©pendance de la RDC</li>
        <li>√âconomie : Les principes de la micro√©conomie</li>
      </ul>
      <p>üí° **Astuce :** Ces fiches sont synchronis√©es avec les quiz pour une r√©vision compl√®te.</p>
      <button onclick="changerPage('dashboard')">Retour √† l'accueil</button>
  </div>

  <div id="defisPage" class="content-page" style="display: none;">
      <h2>üèÜ D√©fis de la Semaine</h2>
      <p>C'est ici que tu peux te mesurer √† d'autres √©tudiants de l'ISC Lwanga !</p>
      
      <h3>D√©fis Actuels :</h3>
      <p>Challenge : R√©pondre correctement √† 20 questions de Droit en moins de 5 minutes.</p>
      <p style="font-weight: bold; color: green;">Statut : Non commenc√©</p>
      <p>Prochain d√©fi disponible : demain √† 18h00.</p>
      <button onclick="changerPage('dashboard')">Retour √† l'accueil</button>
  </div>

  <div id="coachingPage" class="content-page" style="display: none;">
      <h2>üß† Coaching IA</h2>
      <p>Besoin d'aide sur un concept ? Demande √† notre IA coach !</p>
      
      <textarea placeholder="Ex: Explique-moi la diff√©rence entre l'inflation et la d√©flation." rows="4" style="width: 100%; padding: 10px; border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;"></textarea>
      <button style="background-color: #e74c3c; margin-bottom: 20px;">Poser la question</button>
      
      <p style="font-size: 0.9em; color: #888;">*Note : Le coaching IA est une simulation pour l'instant.*</p>
      <button onclick="changerPage('dashboard')">Retour √† l'accueil</button>
  </div>

  <footer>Con√ßu avec passion par <strong>Gabby Umba ‚Äî ISC Lwanga</strong></footer>

  <script>
    // ‚ö†Ô∏è CONFIGURATION FIREBASE
    const firebaseConfig = {
      apiKey: "AIzaSyAuHPWVOkd96xPqKQ_K1cC4n4ihuPfuNFQ",
      authDomain: "abiga-1718.firebaseapp.com",
      projectId: "abiga-1718",
      storageBucket: "abiga-1718.appspot.com",
      messagingSenderId: "103455679291",
      appId: "1:103455679291:web:eda13441fedfce226d4d1e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const pages = {
        'dashboard': 'dashboardPage',
        'quiz': 'dashboardPage', 
        'fiches': 'fichesPage',
        'defis': 'defisPage',
        'coaching': 'coachingPage'
    };

    let essais = {}; 
    let questionsDuJour = []; 
    let questionsReussies = new Set(); 
    const MAX_QUESTIONS = 5; 
    const PROGRESSION_PAR_QUESTION = 5; 
    let progressionActuelle = 0; 
    let matieresDisponibles = new Set(); // Pour le filtrage

    // --- GESTION DE LA PROGRESSION ---
    
    window.onload = () => {
        progressionActuelle = parseInt(localStorage.getItem('user_progress')) || 0;
        mettreAJourProgressionUI();
        chargerMatieresDisponibles(); // Charge le filtre au d√©marrage
    };

    function mettreAJourProgressionUI() {
        document.getElementById("progressBar").style.width = progressionActuelle + "%";
        document.getElementById("progressText").textContent = progressionActuelle + "%";
        localStorage.setItem('user_progress', progressionActuelle);

        if (progressionActuelle >= 100) {
            alert("F√©licitations ! Tu as atteint ton objectif de r√©vision pour cette semaine. R√©initialisation de la progression.");
            progressionActuelle = 0;
            mettreAJourProgressionUI();
        }
    }


    // --- GESTION DU FILTRE DE MATI√àRE ---

    async function chargerMatieresDisponibles() {
        const selectElement = document.getElementById("matiereSelect");
        
        try {
            // R√©cup√®re TOUS les documents (n√©cessaire pour obtenir toutes les mati√®res)
            const snapshot = await db.collection("quizzes").get();
            
            matieresDisponibles.clear();
            snapshot.forEach(doc => {
                const matiere = doc.data().mati√®re;
                if (matiere) {
                    matieresDisponibles.add(matiere.trim());
                }
            });

            // Supprimer toutes les options sauf la premi√®re ("Tout")
            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            // Ajouter les nouvelles options
            matieresDisponibles.forEach(matiere => {
                const option = document.createElement('option');
                option.value = matiere;
                option.textContent = matiere;
                selectElement.appendChild(option);
            });
            
        } catch (error) {
            console.error("Erreur lors du chargement des mati√®res : ", error);
        }
    }
    
    function changerMatiere() {
        // Recharge le quiz imm√©diatement apr√®s avoir chang√© la mati√®re
        chargerQuiz(); 
    }

    // --- FONCTION DE NAVIGATION ---
    
    function changerPage(pageId) {
        const allPageContainers = document.querySelectorAll('#dashboardPage, .content-page');
        
        allPageContainers.forEach(page => {
            page.style.display = 'none';
        });
        
        const targetPageElement = document.getElementById(pages[pageId]);
        if (targetPageElement) {
            targetPageElement.style.display = 'block';
        }
        
        // Si on clique sur le bouton Quiz (depuis la grille), on charge le quiz.
        if (pageId === 'quiz') {
            chargerQuiz(); 
        }
    }


    // --- FONCTIONS DU QUIZ AVEC FILTRE ---

    async function chargerQuiz() {
      const container = document.getElementById("quizContainer");
      container.innerHTML = "Chargement des questions...";
      
      const matiereSelectionnee = document.getElementById("matiereSelect").value;
      let query = db.collection("quizzes");
      
      // FILTRE PAR MATI√àRE : Si "tout" n'est pas s√©lectionn√©, ajouter la clause where()
      if (matiereSelectionnee !== 'tout') {
          query = query.where("mati√®re", "==", matiereSelectionnee);
      }

      try {
        // Ex√©cution de la requ√™te filtr√©e (ou non)
        const snapshot = await query.get();

        if (snapshot.empty) {
             container.innerHTML = `<div class='page'>Aucune question trouv√©e pour la mati√®re : <strong>${matiereSelectionnee}</strong>.</div>`;
             return;
        }

        const toutesLesQuestions = [];
        snapshot.forEach(doc => {
            toutesLesQuestions.push({ id: doc.id, ...doc.data() }); 
        });

        // 1. M√©langer le tableau de questions
        toutesLesQuestions.sort(() => Math.random() - 0.5); 
        
        // 2. S√©lectionner les X premi√®res questions
        questionsDuJour = toutesLesQuestions.slice(0, MAX_QUESTIONS);
        questionsReussies.clear(); 
        essais = {}; 

        container.innerHTML = ""; 
        
        if (questionsDuJour.length === 0) {
            container.innerHTML = "<div class='page'>Aucune question n'a √©t√© s√©lectionn√©e.</div>";
            return;
        }

        // 3. Afficher les questions s√©lectionn√©es
        questionsDuJour.forEach(data => {
          const safeExplication = data.explication ? data.explication.replace(/'/g, "\\'") : '';
          const safeReponses = data.bonneReponse ? data.bonneReponse.replace(/'/g, "\\'") : '';

          const div = document.createElement('div');
          div.className = 'page';
          div.innerHTML = `
            <p style="font-size: 0.9em; color: #888;">[${data.mati√®re} - ${data.niveau}]</p>
            <h3>${data.question}</h3>
            ${data.options.map(opt => `
              <button onclick="verifierReponse(this, '${opt.replace(/'/g, "\\'")}', '${safeReponses}', \`${safeExplication}\`, '${data.id}')">${opt}</button>
            `).join('')}
            `;
          container.appendChild(div);
        });

      } catch (error) {
        console.error("Erreur lors du chargement des quizzes : ", error);
        container.innerHTML = "<div class='page'>Erreur de connexion √† la base de donn√©es. V√©rifiez les r√®gles Firestore.</div>";
      }
    }

    /**
     * V√©rifie la r√©ponse du quiz et fournit un feedback visuel.
     */
    function verifierReponse(element, reponse, bonneReponse, explication, questionId) {
        if (!essais[questionId]) essais[questionId] = 0;
        
        const parentDiv = element.closest('.page');
        const optionsButtons = parentDiv.querySelectorAll('button');
        let explicationDiv = parentDiv.querySelector('.explication');
        
        if (questionsReussies.has(questionId)) return;

        if (!explicationDiv) {
            explicationDiv = document.createElement('div');
            explicationDiv.className = 'explication';
            parentDiv.appendChild(explicationDiv);
        }

        explicationDiv.style.display = 'block';
        
        // Si la r√©ponse est correcte
        if (reponse.trim() === bonneReponse.trim()) {
            element.style.backgroundColor = '#25D366'; // Vert
            element.style.boxShadow = '0 0 10px rgba(37, 211, 102, 0.5)';
            explicationDiv.style.borderLeftColor = '#25D366';
            
            explicationDiv.innerHTML = `‚úÖ **Bonne r√©ponse !**<br> ${explication}`;
            
            if (!questionsReussies.has(questionId)) {
                questionsReussies.add(questionId);
                progressionActuelle += PROGRESSION_PAR_QUESTION;
                mettreAJourProgressionUI();
            }

            optionsButtons.forEach(btn => btn.disabled = true); 
        } 
        // Si la r√©ponse est incorrecte
        else {
            essais[questionId]++;
            element.style.backgroundColor = '#E57373'; // Rouge
            
            if (essais[questionId] >= 3) {
                optionsButtons.forEach(btn => {
                    if (btn.textContent.trim() === bonneReponse.trim()) {
                        btn.style.backgroundColor = '#25D366';
                        btn.style.opacity = 1;
                    }
                    btn.disabled = true; 
                });
                
                explicationDiv.style.borderLeftColor = '#E57373';
                explicationDiv.innerHTML = `‚ùå **Fin des essais.**<br>La bonne r√©ponse √©tait : **${bonneReponse}**.<br>üìò Explication : ${explication}`;
                
            } else {
                optionsButtons.forEach(btn => btn.disabled = false); 
                element.disabled = true; 
                
                explicationDiv.style.borderLeftColor = '#E57373';
                explicationDiv.innerHTML = `‚ùå Mauvaise r√©ponse. Essaie encore (Tentative ${essais[questionId]} / 3)`;
            }
        }
    }
  </script>
</body>
</html>
