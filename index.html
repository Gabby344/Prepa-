<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Prépa+ — Révise avec clarté</title>

  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Open+Sans:wght@400;600;700&display=swap" rel="stylesheet" />

  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore-compat.js"></script>
  <script src="https://unpkg.com/@google/genai@0.1.0/dist/index.umd.js"></script> 

  <style>
    /* VARIABLES DE COULEUR */
    :root {
      --primary-color: #1C3D5A; 
      --secondary-color: #2ECC71; 
      --background-light: #F8F9FA; 
      --card-bg: #FFFFFF; 
      --text-dark: #34495E; 
      --error-color: #E74C3C; 
      --shadow-strong: 0 10px 30px rgba(0, 0, 0, 0.2); /* Nouvelle ombre */
    }

    /* BACKGROUND ET BODY */
    body {
      font-family: 'Open Sans', sans-serif;
      color: var(--text-dark);
      margin: 0;
      padding: 0; 
      text-align: center;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    /* COUCHE D'ARRIÈRE-PLAN AVEC IMAGE */
    .background-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: url('IMG_7393.jpeg') no-repeat center center/cover; 
      z-index: -2; 
    }

    /* FILTRE ASSOMBRISSANT (pour lisibilité) */
    .background-overlay::after {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.45); 
        z-index: -1;
    }
    
    /* CONTENEUR PRINCIPAL DU CONTENU */
    #main-content {
        padding: 30px 20px;
        flex-grow: 1;
        animation: fadeIn 1.5s ease forwards;
    }
    
    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(15px); }
      to { opacity: 1; transform: translateY(0); }
    }
    
    /* CONTENEUR POUR ALIGNER LOGO ET BOUTON */
    .header-content {
        display: flex;
        justify-content: space-between;
        align-items: center;
        max-width: 500px; 
        margin: 0 auto;
        padding: 0 10px;
    }

    /* EN-TÊTE */
    .logo {
      font-family: 'Playfair Display', serif;
      font-size: 3em;
      margin-top: 10px;
      color: var(--card-bg);
      font-weight: 700;
      text-shadow: 0 2px 5px rgba(0, 0, 0, 0.5);
    }
    
    /* BOUTON 'À PROPOS' DANS LE HEADER */
    .about-button {
        padding: 8px 13px;
        font-size: 1.1em;
        font-weight: 700;
        line-height: 1;
        background-color: rgba(255, 255, 255, 0.2); 
        color: var(--card-bg);
        border: 1px solid rgba(255, 255, 255, 0.4);
        border-radius: 50%;
        cursor: pointer;
        transition: background-color 0.2s, transform 0.1s;
        box-shadow: 0 2px 5px rgba(0, 0, 0, 0.3);
        margin-top: 10px;
    }

    .about-button:hover {
        background-color: rgba(255, 255, 255, 0.4);
    }

    .slogan {
      font-style: italic;
      font-size: 1.1em;
      margin-bottom: 40px;
      color: #D5DBDB; 
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5);
    }

    /* NAVIGATION GRID */
    .grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
      max-width: 500px;
      margin: 0 auto 35px;
    }

    .grid button {
      padding: 20px 15px;
      font-size: 1.1em;
      font-weight: 600;
      background-color: var(--primary-color);
      color: var(--card-bg);
      border: none;
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.1);
      text-transform: uppercase;
    }
    
    .grid button:hover {
      background-color: #294A64; 
      transform: translateY(-2px);
      box-shadow: 0 6px 12px rgba(0, 0, 0, 0.15);
    }

    /* PROGRESSION */
    .progress {
      margin: 20px auto 10px; 
      width: 90%;
      max-width: 500px;
      background-color: #ECF0F1; 
      border-radius: 20px;
      overflow: hidden;
      height: 15px; 
      box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .progress-bar {
      height: 100%;
      width: 0%; 
      background-color: var(--secondary-color);
      transition: width 1s ease-in-out;
      border-radius: 20px 0 0 20px;
      box-shadow: none;
    }

    /* Texte de Progression */
    .progress-status {
      background: rgba(255, 255, 255, 0.9); 
      padding: 5px 15px;
      border-radius: 8px;
      display: inline-block; 
      margin-top: 0; 
      font-size: 1.05em;
      font-weight: 700 !important; 
      color: var(--primary-color) !important;
      margin-bottom: 5px;
    }

    /* Citation (Proverbe) */
    .quote {
      margin: 15px auto 35px; 
      max-width: 500px;
      font-size: 1.05em;
      font-style: italic;
      color: var(--card-bg); 
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.5); 
      padding: 0 10px;
    }

    /* CARTES QUIZ & PAGES DE CONTENU */
    .page, .content-page {
      background: var(--card-bg);
      border: none;
      border-radius: 15px;
      padding: 25px;
      margin: 25px auto;
      width: 95%;
      max-width: 500px;
      text-align: left;
      box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15); 
    }
    
    /* =========================================== */
    /* NOUVEAU/MODIFIÉ: STYLE PAGE À PROPOS (ABOUT) */
    /* =========================================== */
    #aboutPage {
        padding: 30px;
        box-shadow: var(--shadow-strong); /* Ombre plus prononcée */
    }

    #aboutPage h2 {
        color: var(--primary-color);
        border-bottom: 3px solid var(--secondary-color);
        padding-bottom: 10px;
        margin-bottom: 25px;
        text-align: center;
    }
    
    .developer-info {
        text-align: center;
        padding: 20px 0;
        margin-top: 25px;
        border-top: 1px solid #ECEFF1;
    }

    .developer-photo {
        width: 100px;
        height: 100px;
        border-radius: 50%;
        object-fit: cover;
        margin: 0 auto 15px;
        border: 4px solid var(--secondary-color); /* Bordure stylée */
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
        display: block;
        background-color: #ECF0F1; /* Placeholder visuel */
    }

    .close-button-pro {
        /* Remplacement du style de bouton par défaut pour le Fermer */
        display: block;
        width: 60%; 
        max-width: 250px;
        margin: 30px auto 0;
        padding: 12px 20px;
        background-color: var(--text-dark); /* Couleur sombre pour un look pro */
        color: white;
        border: none;
        border-radius: 25px; /* Forme de pilule */
        font-weight: 700;
        text-transform: uppercase;
        letter-spacing: 1px;
        cursor: pointer;
        transition: background-color 0.3s ease, transform 0.1s ease;
        box-shadow: 0 5px 15px rgba(52, 73, 94, 0.4);
    }
    
    .close-button-pro:hover {
        background-color: var(--primary-color); /* Changement au survol */
        transform: translateY(-2px);
    }

    /* Reste du CSS pour le quiz, etc. (non modifié en profondeur) */

    #quizContainer .page {
        margin: 0 auto 25px; 
        padding: 30px; 
    }

    #quizContainer .page[style*="text-align: center"] {
        font-size: 1.1em;
        line-height: 1.6;
        color: var(--text-dark);
        font-weight: 400;
    }
    
    .page h3 {
      margin-bottom: 20px;
      font-size: 1.25em; 
      color: var(--text-dark);
      font-weight: 700;
      line-height: 1.4;
    }

    .page button {
      display: block;
      margin: 8px 0;
      padding: 15px 15px; 
      width: 100%;
      background-color: #F8F9FA; 
      color: var(--text-dark);
      border: 1px solid #EAECEE;
      border-radius: 10px;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease, border-color 0.2s;
      text-align: left;
      font-size: 1em;
      font-weight: 500;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
    }

    .page button:hover:not([disabled]) {
      background-color: #E5E7E9;
      border-color: var(--primary-color);
    }

    .explication {
        margin-top: 15px;
        padding: 15px;
        border-left: 5px solid; 
        background-color: #F8F9FA; 
        border-radius: 0 8px 8px 0;
        font-size: 0.95em;
        line-height: 1.5;
        text-align: left;
    }
    
    /* FILTRE QUIZ */
    .quiz-filter {
        text-align: center;
        padding: 25px;
        background-color: var(--card-bg);
        border-radius: 15px;
        box-shadow: 0 8px 25px rgba(0,0,0,0.15); 
        max-width: 500px;
        margin: 0 auto 25px;
    }

    .quiz-filter label {
        display: block; 
        font-size: 0.95em;
        font-weight: 600;
        color: #7F8C8D; 
        margin-bottom: 8px;
        text-align: left;
    }

    .quiz-filter select {
        display: block;
        width: 100%; 
        padding: 12px 15px; 
        border-radius: 10px;
        border: 1px solid #BDC3C7;
        margin-left: 0; 
        margin-bottom: 20px;
        background-color: #F8F9FA;
        font-size: 1em;
        color: var(--text-dark);
    }
    
    .quiz-filter button {
        width: 100%; 
        padding: 15px 20px; 
        background-color: var(--secondary-color); 
        color: white;
        border: none;
        border-radius: 10px;
        font-weight: 700;
        transition: background-color 0.2s;
        box-shadow: 0 4px 10px rgba(46, 204, 113, 0.4); 
    }
    .quiz-filter button:hover {
      background-color: #27AE60;
      transform: none; 
    }
    
    /* BOUTON ADMIN */
    .admin-link {
      margin-top: 50px;
      padding-bottom: 50px; 
    }

    .admin-link a {
      text-decoration: none;
    }

    .admin-link button {
      padding: 15px 30px; 
      background-color: #BDC3C7; 
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 1em; 
      font-weight: 600;
      cursor: pointer;
      transition: background-color 0.2s ease, transform 0.1s ease;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      width: 70%; 
      max-width: 300px;
    }
    .admin-link button:hover {
      background-color: #95A5A6;
      transform: translateY(-1px);
    }

    footer {
      width: 100%;
      padding: 15px 0;
      font-size: 0.85em;
      color: #95A5A6;
      font-weight: 600;
      background-color: rgba(255, 255, 255, 0.8); 
      margin-top: auto; 
      z-index: 10;
    }
  </style>
</head>
<body>
  
  <div class="background-overlay"></div>
  
  <div id="main-content">

    <div id="dashboardPage"> 
      
      <div class="header-content">
        <div class="logo">📘 Prépa+</div>
        <button class="about-button" onclick="changerPage('about')">i</button>
      </div>
      
      <div class="slogan">Révise avec clarté. Progresse avec fierté.</div>

      <div class="grid">
        <button onclick="changerPage('quiz')">📚 Quiz</button> 
        <button onclick="changerPage('fiches')">📄 Fiches</button>
        <button onclick="changerPage('defis')">🏆 Défis</button>
        <button onclick="changerPage('coaching')">🧠 Coaching IA</button>
      </div>

      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>
      <p class="progress-status">Tu as révisé <strong id="progressText">0%</strong> cette semaine</p>

      <div class="quote">“Ton avenir mérite ton attention aujourd’hui.” — Proverbe Africain</div>
      
      <div class="quiz-filter">
          <label for="matiereSelect">Filtrer par Matière :</label>
          <select id="matiereSelect" onchange="changerMatiere()">
              <option value="tout">Toutes les Matières</option>
              </select>
          <button onclick="chargerQuiz()">Lancer le Quiz</button>
      </div>

      <div id="quizContainer">
          <div class="page" style="text-align: center; padding: 40px;">
              <strong>Sélectionne une matière</strong> ou clique sur le bouton <strong>"Lancer le Quiz"</strong> pour commencer ta session de révision !
          </div>
      </div>

      <div class="admin-link">
        <a href="admin.html"><button>🔐 Accès Administration</button></a>
      </div>

    </div> 

    <div id="aboutPage" class="content-page" style="display: none;">
        <h2>À Propos de Prépa+</h2>
        <p style="text-align: center; color: var(--primary-color); font-weight: 600;">L'application qui optimise votre réussite scolaire.</p>
        
        <h3 style="color: var(--text-dark);">🚀 Rôle et Importance pour les Élèves</h3>
        <p style="font-size: 0.95em; line-height: 1.5;">Prépa+ n'est pas seulement une application de quiz ; c'est votre partenaire de révision stratégique. Son rôle est de combler l'écart entre le cours en classe et l'examen en offrant :</p>
        <ul style="list-style-type: '👉'; padding-left: 20px; font-size: 0.9em; line-height: 1.5;">
          <li><span style="margin-left: 10px;">Révision Ciblée : Des quiz basés sur le programme pour maximiser l'efficacité de votre temps d'étude.</span></li>
          <li><span style="margin-left: 10px;">Feedback Immédiat : Des explications détaillées après chaque réponse pour transformer les erreurs en opportunités d'apprentissage.</span></li>
          <li><span style="margin-left: 10px;">Coaching IA : Un tuteur disponible 24/7 pour clarifier les concepts complexes à tout moment.</span></li>
        </ul>
        
        <div class="developer-info">
            <h3 style="color: var(--text-dark); margin-top: 0;">👨‍💻 Le Développeur</h3>
            <img src="IMG_6953.jpeg" alt="Photo de Gabby Umba, Développeur" class="developer-photo" />
            <p style="font-size: 0.95em; line-height: 1.5; text-align: center;">Je m'appelle **Gabby Umba**, et j'ai développé cette plateforme pour les élèves du monde et en particulier ceux de la RDC. Mon objectif est de fournir une solution simple, puissante et pertinente, construite avec passion pour le succès des élèves.</p>
        </div>
        
        <button onclick="changerPage('dashboard')" class="close-button-pro">Fermer la page</button>
    </div>
    <div id="fichesPage" class="content-page" style="display: none;">
        <h2>📄 Mes Fiches de Révision</h2>
        <p style="text-align: center; color: #555;">Consolide tes connaissances par la lecture de fiches thématiques.</p>
        
        <h3 style="color: var(--primary-color);">Thèmes Disponibles :</h3>
        <ul style="list-style-type: '👉'; padding-left: 20px;">
          <li><span style="margin-left: 10px;">Géographie : Les grands fleuves africains</span></li>
          <li><span style="margin-left: 10px;">Histoire : L'indépendance de la RDC</span></li>
          <li><span style="margin-left: 10px;">Économie : Les principes de la microéconomie</span></li>
        </ul>
        <p style="font-size: 0.9em; margin-top: 25px; text-align: left; color: #7F8C8D;">💡 **Astuce :** Ces fiches sont directement liées aux questions des quiz.</p>
        <button onclick="changerPage('dashboard')">Retour à l'accueil</button>
    </div>

    <div id="defisPage" class="content-page" style="display: none;">
        <h2>🏆 Défis de la Semaine</h2>
        <p style="text-align: center; color: #555;">Mesure-toi à d'autres étudiants de l'ISC Lwanga et grimpe dans le classement !</p>
        
        <h3 style="color: var(--primary-color);">Défi Actuel :</h3>
        <p style="font-weight: bold; color: var(--text-dark); margin-bottom: 5px;">Challenge : Répondre correctement à 20 questions de Droit en moins de 5 minutes.</p>
        <p style="font-weight: 700; color: var(--secondary-color); font-size: 1.1em; text-align: center;">Statut : Non commencé</p>
        <p style="font-size: 0.9em; color: #7F8C8D; text-align: center;">Prochain défi disponible : demain à 18h00.</p>
        <button onclick="changerPage('dashboard')">Retour à l'accueil</button>
    </div>

    <div id="coachingPage" class="content-page" style="display: none;">
        <h2>🧠 Coaching IA</h2>
        <p style="text-align: center; color: #555;">Pose tes questions sur n'importe quel concept et obtiens une explication rapide.</p>
        
        <textarea id="aiQuestionInput" placeholder="Ex: Explique-moi la différence entre l'inflation et la déflation." rows="4" style="width: 100%; padding: 15px; border-radius: 8px; border: 1px solid #BDC3C7; box-sizing: border-box; resize: none;"></textarea>
        
        <button onclick="poserQuestionIA()" style="background-color: var(--primary-color); color: white; margin-bottom: 20px;">Poser la question à l'IA</button>
        
        <div id="aiResponseArea" class="page" style="text-align: left; padding: 15px; background: #EAF2FF; border-left: 5px solid var(--primary-color); display: none; margin-top: 10px;">
            <p style="font-weight: 700; color: var(--primary-color);">Réponse du Coach IA :</p>
            <p id="aiResponseText"></p>
        </div>

        <p style="font-size: 0.85em; color: var(--error-color); text-align: center; margin-top: 10px;">
          *Attention : **Clé API exposée** dans le JS pour ce test. Solution déconseillée en production.*
        </p>
        <button onclick="changerPage('dashboard')">Retour à l'accueil</button>
    </div>

  </div> <footer>Conçu par <strong>Gabby Umba</strong></footer>

  <script>
    // ⚠️ CONFIGURATION FIREBASE (non modifiée)
    const firebaseConfig = {
      apiKey: "AIzaSyAuHPWVOkd96xPqKQ_K1cC4n4ihuPfuNFQ",
      authDomain: "abiga-1718.firebaseapp.com",
      projectId: "abiga-1718",
      storageBucket: "abiga-1718.appspot.com",
      messagingSenderId: "103455679291",
      appId: "1:103455679291:web:eda13441fedfce226d4d1e"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    const pages = {
        'dashboard': 'dashboardPage',
        'quiz': 'dashboardPage', 
        'fiches': 'fichesPage',
        'defis': 'defisPage',
        'coaching': 'coachingPage',
        'about': 'aboutPage' // Nouvelle page ajoutée
    };

    let essais = {}; 
    let questionsDuJour = []; 
    let questionsReussies = new Set(); 
    const MAX_QUESTIONS = 5; 
    const PROGRESSION_PAR_QUESTION = 5; 
    let progressionActuelle = 0; 
    let matieresDisponibles = new Set(); 

    // ===========================================
    // 🧠 CONFIGURATION IA (INTÉGRATION DIRECTE)
    // 🚨 REMPLACER LA CHAÎNE CI-DESSOUS
    // ===========================================
    
    const GEMINI_API_KEY_CLIENT = 'VOTRE_CLE_API_GEMINI_ICI'; 
    const ai = new GoogleGenAI(GEMINI_API_KEY_CLIENT);


    // --- GESTION DE LA PROGRESSION ---
    
    window.onload = () => {
        progressionActuelle = parseInt(localStorage.getItem('user_progress')) || 0;
        mettreAJourProgressionUI();
        chargerMatieresDisponibles(); 
    };

    function mettreAJourProgressionUI() {
        document.getElementById("progressBar").style.width = progressionActuelle + "%";
        document.getElementById("progressText").textContent = progressionActuelle + "%";
        localStorage.setItem('user_progress', progressionActuelle);

        if (progressionActuelle >= 100) {
            alert("Félicitations ! Tu as atteint ton objectif de révision pour cette semaine. Réinitialisation de la progression.");
            progressionActuelle = 0;
            mettreAJourProgressionUI();
        }
    }

    // --- FONCTION DE NAVIGATION ---
    
    function changerPage(pageId) {
        const allPageContainers = document.querySelectorAll('.content-page');
        allPageContainers.forEach(page => {
            page.style.display = 'none';
        });
        
        document.getElementById('dashboardPage').style.display = 'block';

        if (pageId !== 'dashboard' && pageId !== 'quiz') {
            document.getElementById('quizContainer').style.display = 'none';
            document.querySelector('.quiz-filter').style.display = 'none';

            // Utiliser l'objet 'pages' pour trouver le bon ID de conteneur
            const containerId = pages[pageId];
            if (containerId) {
                document.getElementById(containerId).style.display = 'block';
            }
        } else {
            document.getElementById('quizContainer').style.display = 'block';
            document.querySelector('.quiz-filter').style.display = 'block';
        }
    }

    // --- FONCTION QUIZ ---

    async function chargerMatieresDisponibles() {
        const selectElement = document.getElementById("matiereSelect");
        
        try {
            const snapshot = await db.collection("quizzes").get();
            
            matieresDisponibles.clear();
            snapshot.forEach(doc => {
                const matiere = doc.data().matière;
                if (matiere) {
                    matieresDisponibles.add(matiere.trim());
                }
            });

            while (selectElement.options.length > 1) {
                selectElement.remove(1);
            }

            matieresDisponibles.forEach(matiere => {
                const option = document.createElement('option');
                option.value = matiere;
                option.textContent = matiere;
                selectElement.appendChild(option);
            });
            
        } catch (error) {
            console.error("Erreur lors du chargement des matières : ", error);
        }
    }
    
    function changerMatiere() {
        // Aucune action ici, le quiz est lancé par le bouton
    }

    async function chargerQuiz() {
      const container = document.getElementById("quizContainer");
      container.innerHTML = "<div class='page' style='text-align: center;'>Chargement des questions...</div>";
      
      const matiereSelectionnee = document.getElementById("matiereSelect").value;
      let query = db.collection("quizzes");
      
      if (matiereSelectionnee !== 'tout') {
          query = query.where("matière", "==", matiereSelectionnee);
      }

      try {
        const snapshot = await query.get();

        if (snapshot.empty) {
             container.innerHTML = `<div class='page' style='text-align: center;'>Aucune question trouvée pour la matière : <strong>${matiereSelectionnee}</strong>.</div>`;
             return;
        }

        const toutesLesQuestions = [];
        snapshot.forEach(doc => {
            toutesLesQuestions.push({ id: doc.id, ...doc.data() }); 
        });

        toutesLesQuestions.sort(() => Math.random() - 0.5); 
        
        questionsDuJour = toutesLesQuestions.slice(0, MAX_QUESTIONS);
        questionsReussies.clear(); 
        essais = {}; 

        container.innerHTML = ""; 
        
        if (questionsDuJour.length === 0) {
            container.innerHTML = "<div class='page' style='text-align: center;'>Aucune question n'a été sélectionnée.</div>";
            return;
        }

        questionsDuJour.forEach(data => {
          const safeExplication = data.explication ? data.explication.replace(/'/g, "\\'") : '';
          const safeReponses = data.bonneReponse ? data.bonneReponse.replace(/'/g, "\\'") : '';

          const div = document.createElement('div');
          div.className = 'page';
          div.innerHTML = `
            <p style="font-size: 0.85em; color: #95A5A6; margin-bottom: 5px;">[${data.matière} - ${data.niveau}]</p>
            <h3>${data.question}</h3>
            ${data.options.map(opt => `
              <button onclick="verifierReponse(this, '${opt.replace(/'/g, "\\'")}', '${safeReponses}', \`${safeExplication}\`, '${data.id}')">${opt}</button>
            `).join('')}
          `;
          container.appendChild(div);
        });

      } catch (error) {
        console.error("Erreur lors du chargement des quizzes : ", error);
        container.innerHTML = "<div class='page' style='text-align: center;'>Erreur de connexion à la base de données.</div>";
      }
    }

    /**
     * Vérifie la réponse du quiz et fournit un feedback visuel.
     */
    function verifierReponse(element, reponse, bonneReponse, explication, questionId) {
        if (!essais[questionId]) essais[questionId] = 0;
        
        const parentDiv = element.closest('.page');
        const optionsButtons = parentDiv.querySelectorAll('button');
        let explicationDiv = parentDiv.querySelector('.explication');
        
        if (questionsReussies.has(questionId)) return;

        if (!explicationDiv) {
            explicationDiv = document.createElement('div');
            explicationDiv.className = 'explication';
            parentDiv.appendChild(explicationDiv);
        }

        explicationDiv.style.display = 'block';
        
        // Si la réponse est correcte
        if (reponse.trim() === bonneReponse.trim()) {
            element.style.backgroundColor = 'var(--secondary-color)'; 
            element.style.color = 'white';
            element.style.boxShadow = '0 0 10px rgba(46, 204, 113, 0.5)';
            explicationDiv.style.borderLeftColor = 'var(--secondary-color)';
            
            explicationDiv.innerHTML = `✅ **Bonne réponse !**<br> ${explication}`;
            
            if (!questionsReussies.has(questionId)) {
                questionsReussies.add(questionId);
                progressionActuelle += PROGRESSION_PAR_QUESTION;
                mettreAJourProgressionUI();
            }

            optionsButtons.forEach(btn => btn.disabled = true); 
        } 
        // Si la réponse est incorrecte
        else {
            essais[questionId]++;
            element.style.backgroundColor = 'var(--error-color)'; 
            element.style.color = 'white';
            
            if (essais[questionId] >= 3) {
                optionsButtons.forEach(btn => {
                    if (btn.textContent.trim() === bonneReponse.trim()) {
                        btn.style.backgroundColor = 'var(--secondary-color)'; 
                        btn.style.color = 'white';
                    }
                    btn.disabled = true; 
                });
                
                explicationDiv.style.borderLeftColor = 'var(--error-color)';
                explicationDiv.innerHTML = `❌ **Fin des essais.**<br>La bonne réponse était : **${bonneReponse}**.<br>📘 Explication : ${explication}`;
                
            } else {
                optionsButtons.forEach(btn => btn.disabled = false); 
                element.disabled = true; 
                
                explicationDiv.style.borderLeftColor = 'var(--error-color)';
                explicationDiv.innerHTML = `❌ Mauvaise réponse. Essaie encore (Tentative ${essais[questionId]} / 3)`;
            }
        }
    }

    // ===========================================
    // 🤖 FONCTION COACHING IA (APPEL DIRECT CLIENT)
    // ===========================================

    async function poserQuestionIA() {
        const input = document.getElementById("aiQuestionInput");
        const responseArea = document.getElementById("aiResponseArea");
        const responseText = document.getElementById("aiResponseText");

        const question = input.value.trim();
        if (!question) {
            alert("Veuillez entrer une question.");
            return;
        }

        // --- Gestion de l'UI ---
        responseArea.style.display = 'block';
        responseArea.style.borderLeftColor = 'var(--primary-color)'; 
        responseText.textContent = "Le Coach IA réfléchit... (Veuillez patienter)";
        
        const button = document.querySelector('#coachingPage button');
        button.disabled = true;
        // --- Fin Gestion de l'UI ---

        // Contexte pour l'IA
        const systemInstruction = `Vous êtes un tuteur de révision nommé Prépa+. Répondez avec précision à la question de l'étudiant en fournissant une explication claire. Votre réponse doit être concise, éducative et formelle.`;

        try {
            const response = await ai.models.generateContent({
                model: "gemini-2.5-flash", 
                contents: [{ role: "user", parts: [{ text: question }] }],
                config: {
                    systemInstruction: systemInstruction,
                    temperature: 0.2, 
                }
            });

            // Afficher la réponse
            const aiAnswer = response.text.trim();
            responseText.innerHTML = aiAnswer.replace(/\n/g, '<br>');
            
        } catch (error) {
            console.error("Erreur d'appel direct à l'API Gemini:", error);
            responseText.innerHTML = `❌ **Erreur :** Impossible de contacter le Coach IA. Vérifiez que la clé API est correcte et que vous êtes bien connecté à Internet.`;
            responseArea.style.borderLeftColor = 'var(--error-color)';
            
        } finally {
            // Réactiver le bouton
            button.disabled = false;
        }
    }
  </script>
</body>
</html>
